<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLM-ASR</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/>
                    </svg>
                </div>
                GLM-ASR
            </div>
            <select id="lang" onchange="setLang(this.value)">
                <option value="en">English</option>
                <option value="zh-CN">简体中文</option>
                <option value="zh-TW">繁體中文</option>
                <option value="ja">日本語</option>
            </select>
        </header>
        <div class="card">
            <div class="card-title" data-i18n="gpu_status">GPU Status</div>
            <div class="gpu-grid">
                <div class="gpu-item"><label data-i18n="model">Model</label><div class="value" id="modelStatus">-</div></div>
                <div class="gpu-item"><label data-i18n="memory">Memory</label><div class="value" id="memoryUsed">-</div></div>
                <div class="gpu-item"><label data-i18n="device">Device</label><div class="value" id="deviceInfo">-</div></div>
            </div>
            <div class="btn-row">
                <button class="secondary" onclick="loadModel()" id="loadBtn" data-i18n="load">Load Model</button>
                <button class="danger" onclick="unloadModel()" id="unloadBtn" data-i18n="unload">Unload</button>
            </div>
        </div>
        <div class="card">
            <div class="card-title" data-i18n="upload_audio">Upload Audio</div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <p data-i18n="drop_hint">Click or drag audio file here</p>
                <input type="file" id="fileInput" accept=".wav,.mp3,.flac,.m4a,.ogg,.webm" onchange="handleFile(this.files[0])">
            </div>
            <div class="file-badge" id="fileBadge"></div>
        </div>
        <div class="card">
            <div class="card-title" data-i18n="parameters">Parameters</div>
            <div class="param-row">
                <label data-i18n="max_tokens">Max New Tokens</label>
                <input type="number" id="maxTokens" value="512" min="1" max="2048">
            </div>
        </div>
        <div class="card">
            <button class="transcribe-btn" onclick="transcribe()" id="transcribeBtn" data-i18n="transcribe">Transcribe</button>
            <div class="progress-wrap" id="progress"><div class="progress-bar" id="progressBar"></div></div>
            <div class="status-text" id="statusMsg"></div>
        </div>
        <div class="card">
            <div class="result-header">
                <div class="card-title" data-i18n="result">Result</div>
                <button class="copy-btn secondary" onclick="copyResult()" data-i18n="copy">Copy</button>
            </div>
            <div class="result-box empty" id="result" data-i18n="result_placeholder">Transcription result will appear here...</div>
        </div>
    </div>
<script>
const i18n={en:{gpu_status:"GPU Status",model:"Model",memory:"Memory",device:"Device",load:"Load Model",unload:"Unload",upload_audio:"Upload Audio",drop_hint:"Click or drag audio file here",parameters:"Parameters",max_tokens:"Max New Tokens",transcribe:"Transcribe",result:"Result",copy:"Copy",result_placeholder:"Transcription result will appear here...",loaded:"Loaded",unloaded:"Unloaded",processing:"Processing",copied:"Copied!",error:"Error",file_selected:"Selected: ",segment:"Segment",complete:"Complete"},"zh-CN":{gpu_status:"GPU 状态",model:"模型",memory:"显存",device:"设备",load:"加载模型",unload:"卸载",upload_audio:"上传音频",drop_hint:"点击或拖拽音频文件到此处",parameters:"参数设置",max_tokens:"最大生成 Token",transcribe:"开始转录",result:"转录结果",copy:"复制",result_placeholder:"转录结果将显示在这里...",loaded:"已加载",unloaded:"未加载",processing:"处理中",copied:"已复制!",error:"错误",file_selected:"已选择: ",segment:"分段",complete:"完成"},"zh-TW":{gpu_status:"GPU 狀態",model:"模型",memory:"顯存",device:"設備",load:"載入模型",unload:"卸載",upload_audio:"上傳音頻",drop_hint:"點擊或拖拽音頻文件到此處",parameters:"參數設置",max_tokens:"最大生成 Token",transcribe:"開始轉錄",result:"轉錄結果",copy:"複製",result_placeholder:"轉錄結果將顯示在這裡...",loaded:"已載入",unloaded:"未載入",processing:"處理中",copied:"已複製!",error:"錯誤",file_selected:"已選擇: ",segment:"分段",complete:"完成"},ja:{gpu_status:"GPU ステータス",model:"モデル",memory:"メモリ",device:"デバイス",load:"モデル読込",unload:"アンロード",upload_audio:"音声アップロード",drop_hint:"クリックまたはドラッグしてファイルを選択",parameters:"パラメータ",max_tokens:"最大トークン数",transcribe:"文字起こし",result:"結果",copy:"コピー",result_placeholder:"文字起こし結果がここに表示されます...",loaded:"読込済",unloaded:"未読込",processing:"処理中",copied:"コピーしました!",error:"エラー",file_selected:"選択済: ",segment:"セグメント",complete:"完了"}};
let currentLang=localStorage.getItem('lang')||'en',selectedFile=null;
function setLang(l){currentLang=l;localStorage.setItem('lang',l);document.getElementById('lang').value=l;document.querySelectorAll('[data-i18n]').forEach(e=>{const k=e.getAttribute('data-i18n');if(i18n[l][k]){if(e.tagName==='INPUT')e.placeholder=i18n[l][k];else e.textContent=i18n[l][k];}});}
function t(k){return i18n[currentLang][k]||k;}
async function fetchStatus(){try{const r=await fetch('/gpu/status'),d=await r.json(),s=document.getElementById('modelStatus');s.textContent=d.model_loaded?t('loaded'):t('unloaded');s.className='value '+(d.model_loaded?'loaded':'unloaded');document.getElementById('memoryUsed').textContent=d.gpu_memory_used_mb?Math.round(d.gpu_memory_used_mb)+' MB':'-';document.getElementById('deviceInfo').textContent=d.device||'-';document.getElementById('loadBtn').disabled=d.model_loaded;document.getElementById('unloadBtn').disabled=!d.model_loaded;}catch(e){console.error(e);}}
async function loadModel(){document.getElementById('loadBtn').disabled=true;document.getElementById('statusMsg').textContent=t('processing');await fetch('/gpu/load',{method:'POST'});await fetchStatus();document.getElementById('statusMsg').textContent='';}
async function unloadModel(){document.getElementById('unloadBtn').disabled=true;await fetch('/gpu/unload',{method:'POST'});await fetchStatus();}
function handleFile(f){if(!f)return;selectedFile=f;const b=document.getElementById('fileBadge');b.textContent=t('file_selected')+f.name+' ('+(f.size/1024/1024).toFixed(2)+' MB)';b.classList.add('show');}

async function transcribe(){
    if(!selectedFile){alert('Please select a file');return;}
    const btn=document.getElementById('transcribeBtn'),prog=document.getElementById('progress'),bar=document.getElementById('progressBar'),msg=document.getElementById('statusMsg'),res=document.getElementById('result');
    btn.disabled=true;prog.classList.add('show');bar.style.width='5%';msg.textContent=t('processing')+'...';res.textContent='';res.classList.add('empty');
    
    const fd=new FormData();fd.append('file',selectedFile);fd.append('max_new_tokens',document.getElementById('maxTokens').value);
    let fullText='';
    let buffer='';
    
    try{
        const response=await fetch('/api/transcribe/stream',{method:'POST',body:fd});
        const reader=response.body.getReader();
        const decoder=new TextDecoder();
        
        while(true){
            const{done,value}=await reader.read();
            if(done)break;
            buffer+=decoder.decode(value,{stream:true});
            
            const lines=buffer.split('\n');
            buffer=lines.pop()||'';
            
            for(const line of lines){
                if(!line.startsWith('data: '))continue;
                const jsonStr=line.slice(6).trim();
                if(!jsonStr||jsonStr==='')continue;
                try{
                    const d=JSON.parse(jsonStr);
                    if(d.type==='progress'){
                        const pct=Math.round((d.current/d.total)*100);
                        bar.style.width=pct+'%';
                        msg.textContent=t('segment')+' '+d.current+'/'+d.total+' ('+d.duration+'s)';
                    }else if(d.type==='partial'){
                        fullText+=d.text;
                        res.textContent=fullText;
                        res.classList.remove('empty');
                    }else if(d.type==='done'){
                        bar.style.width='100%';
                        msg.textContent=t('complete');
                        if(d.text&&d.text.length>fullText.length){
                            res.textContent=d.text;
                        }
                        res.classList.remove('empty');
                    }else if(d.type==='error'){
                        throw new Error(d.message);
                    }
                }catch(e){
                    if(e instanceof SyntaxError)continue;
                    throw e;
                }
            }
        }
    }catch(e){
        res.textContent=t('error')+': '+e.message;
    }finally{
        btn.disabled=false;msg.textContent='';
        setTimeout(()=>prog.classList.remove('show'),500);
    }
}

function copyResult(){const txt=document.getElementById('result').textContent;navigator.clipboard.writeText(txt).then(()=>{const b=event.target,o=b.textContent;b.textContent=i18n[currentLang].copied;setTimeout(()=>b.textContent=o,1500);});}
const uz=document.getElementById('uploadZone');
uz.addEventListener('dragover',e=>{e.preventDefault();uz.classList.add('dragover');});
uz.addEventListener('dragleave',()=>uz.classList.remove('dragover'));
uz.addEventListener('drop',e=>{e.preventDefault();uz.classList.remove('dragover');handleFile(e.dataTransfer.files[0]);});
setLang(currentLang);fetchStatus();setInterval(fetchStatus,5000);
</script>
</body>
</html>
